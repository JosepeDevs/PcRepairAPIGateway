openapi: 3.0.6
info:
  title: TallerPcApi - Endpoints for API Gateway
  description: >-
    API-first planned project with OAS, a global microservices architecture with an API Gateway and Eureka server,
    in which each microservice has been structured using hexagonal architecture.
  termsOfService: https://josepedevs.com/terms/
  contact:
    name: 'Josepedevs'
    url: https://www.josepedevs.com/support
    email: josepedevs@gmail.com
  license:
    name: Apache 2.0
    url: https://www.apache.org/licenses/LICENSE-2.0.html
  version: 1.0.0
servers:
  - url: http://localhost:{port}
    description: Dev/local API Gateway Server
    variables:
      port:
        enum:
          - '7777'
        default: '7777'
      version:
        default: v1
  - url: https://{personname}.josepedevs.com:{port}/{version}
    description: PRODUCTION SERVER
    variables:
      personname:
        default: person
        description: >-
          Personname used when you registered on the provider website, role will
          be checked to restrain access.
      port:
        enum:
          - '8443'
        default: '8443'
      version:
        default: v1
  - url: https://{personname}.josepedevs.com:{port}/{version}
    variables:
      personname:
        default: person
        description: >-
          Personname used when you registered on the provider website, role will
          be checked to restrain access.
      port:
        enum:
          - '8444'
        default: '8444'
      version:
        default: v1
tags:
  - name: PersonManager
    description: "Operations related to individual person management, such as create, update, delete, and retrieve a single person."
  - name: PersonBatch
    description: "Operations related to batch processing of persons, such as bulk import, export, or batch updates."
  - name: CatalogueManager
    description: "Operations related to the Catalogue."
  - name: OrderManager
    description: "Operations related to the Orders."

paths:
  /personmanager/persons:
    post:
      tags:
        - PersonManager
      operationId: createPerson
      summary: Creates a new user, this triggers an asynchronous operation will be sent to the batch to export/update the persons database.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/RestPersonRequestDto'
      responses:
        '201':
          description: User created correctly.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/RestPersonResponseDto'
        '422':
          description: Unprocessable entity, provided information is not valid.
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/ErrorMapList'
        '500':
          description: Internal server error. More information will be provided in the response.
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/ErrorMapList'

    get:
      tags:
        - PersonManager
      operationId: getAll
      summary: Fetches all persons (not market as deleted) from the database
      responses:
        '200':
          description: Fetches all persons (not market as deleted) from the database
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/RestPersonResponseDto'
        '404':
          description: Person not found, the provided id is not in use in the database OR the user is marked as deleted.
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/ErrorMapList'
        '500':
          description: Internal server error. More information will be provided in the response.
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/ErrorMapList'
  /personmanager/persons/{id}:
    put:
      tags:
        - PersonManager
      operationId: updatePerson
      summary: Updates existing person data, triggers asynchronous export in the batch server. Fails if user does not exists.
      parameters:
        - name: id
          in: path
          description: Primary key that identifies the person.
          required: true
          schema:
            $ref: '#/components/schemas/UUIDTimestamp'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/RestPersonRequestDto'
      responses:
        '200':
          description: Person updated successfully.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/RestPersonResponseDto'
        '404':
          description: Person not found, the provided id is not in use in the database.
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/ErrorMapList'
        '422':
          description: Unprocesable entity, provided information is not valid.
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/ErrorMapList'
        '500':
          description: Internal server error. More information will be provided in the response.
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/ErrorMapList'
    get:
      tags:
        - PersonManager
      operationId: getPerson
      summary: Search in database for the provided person's id
      parameters:
        - name: id
          in: path
          description: Primary key that identifies the person.
          required: true
          schema:
            $ref: '#/components/schemas/UUIDTimestamp'
      responses:
        '200':
          description: Person's data dto
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/RestPersonResponseDto'
        '404':
          description: Person not found, the provided id is not in use in the database OR the user is marked as deleted.
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/ErrorMapList'
        '500':
          description: Internal server error. More information will be provided in the response.
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/ErrorMapList'
    delete:
      tags:
        - PersonManager
      operationId: deleteLogicalOfPerson
      summary: Changes column data "deleted" to true, makes recovery of data possible easy.
      parameters:
        - name: id
          in: path
          description: Primary key that identifies the person.
          required: true
          schema:
            $ref: '#/components/schemas/UUIDTimestamp'
      responses:
        '204':
          description: Person deleted marked as deleted successfully
        '404':
          description: Person not found, the provided id is not in use in the database OR the user is already marked as deleted.
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/ErrorMapList'
        '500':
          description: Internal server error. More information will be provided in the response.
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/ErrorMapList'
  /personmanager/persons/hard/{id}:
    delete:
      tags:
        - PersonManager
      operationId: deleteHardPerson
      summary: Physical delete of the person from database.
      parameters:
        - name: id
          in: path
          description: Primary key that identifies the person.
          required: true
          schema:
            $ref: '#/components/schemas/UUIDTimestamp'
      responses:
        '204':
          description: Person deleted marked as deleted successfully
        '404':
          description: Person not found, the provided id is not in use in the database OR the user is already marked as deleted.
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/ErrorMapList'
        '500':
          description: Internal server error. More information will be provided in the response.
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/ErrorMapList'

  /personbatch/run-job:
    post:
      tags:
        - PersonBatch
      operationId: runJob
      summary: Export to a file the current persons table. Either CSV or JSON.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/PropertiesRequestDTO'
      responses:
        '202':
          description: Accepted, this is fire-and-forget. Check output directory to retrieve the file.
          content:
            text/plain:
              schema:
                type: string
                example: "Job started"
        '500':
          description: Some error took place whithin the job. Internal server error. More information will be provided in the response.
          content:
            text/plain:
              schema:
                type: string
                example: "There was some problem with the request: (extra info of the error)"

  /cataloguemanager/repairs_catalogue/{repairId}:
    put:
      tags:
        - CatalogueManager
      operationId: updateCatalogueRepair
      summary: Actualiza un ítem del catálogo (una posible reparación ya existente)
      parameters:
        - name: repairId
          in: path
          description: Primary key that identifies the resource.
          required: true
          schema:
            $ref: '#/components/schemas/UUIDTimestamp'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/repairs_catalogue'
      responses:
        '200':
          description: Posible reparación actualizada exitosamente
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/repairs_catalogue'
        '400':
          description: La petición falló, algún dato de los proporcionados no es válido
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/ErrorMapList'
    delete:
      tags:
        - CatalogueManager
      operationId: deleteCatalogueRepair
      summary: >-
        Elimina un ítem del catálogo (una de las posibles reparaciones que se
        pueden solicitar)
      parameters:
        - name: repairId
          in: path
          description: Primary key that identifies the resource.
          required: true
          schema:
            $ref: '#/components/schemas/UUIDTimestamp'
      responses:
        '204':
          description: Posible reparación eliminada exitosamente
        '400':
          description: La petición falló, algún dato de los proporcionados no es válido
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/ErrorMapList'
  /repair_orders:
    get:
      tags:
        - OrderManager
      operationId: getRepairOrder
      summary: Lista todos los pedidos de reparación
      responses:
        '200':
          description: Lista de pedidos de reparación
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/repair_order'
        '400':
          description: La petición falló, algún dato de los proporcionados no es válido
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/ErrorMapList'
        '403':
          description: >-
            Tus credenciales eran válidas pero no tienes permiso para acceder a
            este recurso
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/ErrorMapList'
    post:
      tags:
        - OrderManager
      operationId: createRepairOrder
      summary: Crea un nuevo pedido de reparación
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/repair_order'
      responses:
        '201':
          description: Pedido de reparación creado exitosamente
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/repair_order'
        '400':
          description: La petición falló, algún dato de los proporcionados no es válido
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/ErrorMapList'
  /repair_orders/{repairId}:
    put:
      tags:
        - OrderManager
      operationId: updateRepairOrder
      summary: Actualiza un pedido de reparación existente
      parameters:
        - name: repairId
          in: path
          description: Primary key that identifies the resource.
          required: true
          schema:
            $ref: '#/components/schemas/UUIDTimestamp'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/repair_order'
      responses:
        '200':
          description: Pedido de reparación actualizado exitosamente
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/repair_order'
        '400':
          description: La petición falló, algún dato de los proporcionados no es válido
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/ErrorMapList'

components:
  schemas:
    UUIDTimestamp:
      type: string
      description: "Primary key that identifies the resource."
      format: uuid-timestamp
      pattern: '^[0-9a-fA-F]{8}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{12}-\d{13}$'
      example: "36d323d3-431d-445c-970a-7707b290f4a1-1764153482464"

    Metadata:
      type: object
      description: "Additional metadata about the person."
      required:
        - age
        - city
        - occupation
        - notes
      example:
        age: 28
        city: "Elche"
        occupation: "Engineer"
        notes: "Person with various interests"
      properties:
        age:
          type: integer
          example: 28
          minimum: 0
        city:
          type: string
          example: "Elche"
        occupation:
          type: string
          example: "Engineer"
        notes:
          type: string
          example: "Enjoys club activities"

    Name:
      type: string
      description: "name and surnames of the person"
      maxLength: 255
      example: "John Doe"

    NidPassport:
      type: string
      description: "National Identifier, accepts spanish NIDs (DNI) along some other options."
      pattern: '^(\d{8}[A-Z]|[A-Za-z]{2}\d{6}|[A-Za-z]{3}\d{6})$'
      example: "12345678A"

    DeletedFlag:
      type: boolean
      description: "Used to define if the user should not appear, is for a logical delete."
      example: false

    RestPersonRequestDto:
      description: "DTO that represents the person's data being sent in a request"
      type: object
      required:
        - id
        - name
        - nidPassport
      properties:
        id:
          $ref: '#/components/schemas/UUIDTimestamp'
        name:
          $ref: '#/components/schemas/Name'
        nidPassport:
          $ref: '#/components/schemas/NidPassport'
        metadata:
          $ref: '#/components/schemas/Metadata'
        deleted:
          $ref: '#/components/schemas/DeletedFlag'

    RestPersonResponseDto:
      description: "DTO that represents the person's data received in the response"
      type: object
      properties:
        id:
          readOnly: true
          $ref: '#/components/schemas/UUIDTimestamp'
        name:
          readOnly: true
          $ref: '#/components/schemas/Name'
        nidPassport:
          readOnly: true
          $ref: '#/components/schemas/NidPassport'
        metadata:
          readOnly: true
          $ref: '#/components/schemas/Metadata'

    ErrorMapList:
      description: >-
        Schema used to notify errors
      type: object
      properties:
        invalid-params:
          type: array
          items:
            type: object
            properties:
              name:
                type: string
              reason:
                type: string
            required:
              - name
              - reason
          example: "people.csv or example.json"
    PropertiesRequestDTO:
      description: >-
        Schema with the configurable variables of the person's export.
        - `outputFileName` and `exportFormat` are required.
        - If `exportFormat` is 'csv', `delimiter` and `includeHeaders` **should be provided**.
        - If `exportFormat` is 'json', `delimiter` and `includeHeaders` are optional.
      type: object
      required:
        - outputFileName
        - exportFormat
      properties:
        outputFileName:
          type: string
          description: "If extension is desired in the generated file must be included here."
          example: "persons_export"
        delimiter:
          type: string
          default: ","
          example: ";"
        includeHeaders:
          type: boolean
          default: true
          example: true
        exportFormat:
          type: string
          enum:
            - csv
            - json
          example: csv

    persons:
      description: Tabla de usuarios
      type: object
      required:
        - id_person
        - email
        - psswrd
      properties:
        id_person:
          type: string
          format: int
          readOnly: true
        email:
          type: string
        psswrd:
          type: string
        name:
          type: string
        role:
          type: string
        active:
          type: boolean
    repairs_catalogue:
      description: Tabla de posibles reparaciones (catálogo)
      type: object
      required:
        - id_repair
        - price
        - discount
        - active
      properties:
        id_repair:
          type: string
          format: int
          readOnly: true
        price:
          type: number
        discount:
          type: number
        active:
          type: boolean
    repair_order:
      description: Tabla de pedidos realizados (reparaciones solicitadas)
      type: object
      required:
        - id_order
        - id_person
        - id_repair
        - price
        - discount
        - order_date
        - active
      properties:
        id_order:
          type: string
          format: int
          readOnly: true
        id_repair:
          type: string
          format: int
        id_person:
          type: string
          format: int
        price:
          type: number
        order_date:
          type: string
          format: date-time
        discount:
          type: number
        active:
          type: boolean

  securitySchemes:
    BearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT

security:
  - BearerAuth: [ ]
